
# Building the Population Explorer database

## Intro

Scripts in this folder are meant to run in sequential order of the numbers, and create the Population Explorer data schema from scratch.  They delete existing copies as they go so be careful!

## Stored procedures

Stored procedures and functions are defined in scripts in the `./build-db/src/` folder.  They only need to be defined when changed.

* clean_out_all (@var_name) - removes all trace of @var_name from the fact and dimension tables
* clean_out_facts (@var_name) - remove the facts from the fact table but leave the value and variable dimension tables un touched **not yet developed**

## Three types of script files

* 01 - 04 - These files set up the tables in the database
* 05 to 60 - These files do the work, one variable at a time, adding information to the database.  Typically this involves creating a simplified set of the variable in "spells", rolling that up to a person-period-value table, then transforming it into the shape needed for the Explorer data model.  For more complex variables this is split into several scripts eg 07a does the basic work on regions lived in, and 07b does the transformation into the Explorer data model.
* 61 onwards - These files do the final amendments to the database to make it analysis ready.  This includes adding indexes and foreign key constraints to the main fact table (this is done *after* the facts have been added, which otherwise would be agonisingly slow); and creating the Views that we expect analysts actually to use.

## Five types of tables

Five types of tables are generated by these scripts:

* tables beginning with `dim` (eg `pop_exp.dim_person`).  These are "dimension tables" that contain unchanging information on the dimensions of people, variables, dates and values.  For example person X is always female and Asian ethnicity; 1 January 2011 is always the first day of the year, in 2011, and a public holiday.  There is also one table called `link_person_extended` which is links together several dimension tables to help make efficient views
* tables beginning with `fact` which have facts for some combination of the dimensions.  The main fact table will have billions of rows, with one row for each combination of person - variable - time period.
* miscellaneous tables with no particular naming convention (other than using snake_case) such as `pop_exp.spells_in_nz`.  These are tables created along the way as intermediate assets to help create the main fact and dimension tables but which aren't strictly needed for the Explorer.  These are left persisting because it is thought that they might be useful future additions to the `IDI_Clean.data` schema in the future.
* temporary tables such as `pop_exp_temp_movements` which we expect to persist over the development of this project - typicaly because they took hours to create - but which aren't valuable enough to make available beyond us.
* temporary tables (eg #tmp) that do not persist beyond the script they are in

Only the first two of these table types are strictly speaking part of the Population Explorer; the others are intermediate objects made for us along the way.

## Two schemas

There are two schemas:

- `pop_exp`
- `pop_exp_dev`

The idea is to use `pop_exp` for stable copies of the database, including indexing on the main fact table and the views used for analysis.  This copy of the database is the one used for demos, the Shiny app, etc.

`pop_exp_dev` is to be used in development.  Apart from preserving `pop_exp` in demo-ready state, this means that new data can be added to the fact tables relatively efficiently (ie without having to do indexing and foreign key integrity checks as it goes)

Only the tables that begin with `dim` (dimension tables) or `fact` (fact tables) are duplicated in both schemas.  Other assets made for this project, such as the `spells_in_nz` table, don't need to be remade each time.

To create a new version of one of the schemas from scratch, most of the files with numbers below 60 need to have a group search and replace done along these lines:

pop_exp_dev.dim <-> pop_exp.dim
pop_exp_dev.fact <-> pop_exp.fact
pop_exp_dev.clean <-> pop_exp.clean

The files with numbers below 60 that *don't* need this done are those that create persistent tables other than fact and dim tables eg script `11a-benefits.sql` which creates `pop_exp.temp_benefits_yemar`.  These scripts all have "a" in their numbering (eg "11a") and do not need to be re-run unless you need a completely clean re-build (takes ages).